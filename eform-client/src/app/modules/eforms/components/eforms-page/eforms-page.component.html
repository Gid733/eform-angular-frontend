<eform-page-subheader [title]="'My eForms' | translate">
  <div class="p-3">
    <button
      class="btn btn-success"
      mdbTooltip="{{ 'Create eForm' | translate }}" id="newEFormBtn" *ngIf="userClaims.eFormsCreate"
      (click)="openNewEformModal()">{{ 'New eForm' | translate }}
    </button>
  </div>
</eform-page-subheader>

<!--Here you can choose approach as you like: container-row, or flex, or just element with required styles and markup-->
<div class="container-fluid">
  <div class="row pl-1">
    <div class="col-md-2">
      <div class="md-form">
        <input mdbInputDirective [mdbValidate]="false"
               type="text" (input)="onLabelInputChanged($event.target.value)"
               class="form-control input-sm" id="labelInput">
        <label for="labelInput">{{'Label' | translate}}</label>
      </div>
    </div>
    <div class="col-md-4 ng-select-wrapper" *ngIf="userClaims.eFormsReadTags">
      <ng-select
        class="custom"
        dropdownPosition="'bottom'"
        [placeholder]="'Tags' | translate"
        [items]="availableTags"
        [(ngModel)]="templateRequestModel.tagIds"
        (add)="saveTag($event)"
        (remove)="removeSavedTag($event)"
        [clearable]="false"
        [bindLabel]="'name'"
        [bindValue]="'id'"
        id="tagSelector"
        [multiple]="true"></ng-select>
    </div>
  </div>
  <div class="row p-1 table-responsive no-gutters">
    <table class="table table-sm table-striped text-center z-depth-1">
      <thead>
      <tr>
        <th scope="col" class="table-header-sortable" id="idSort"
            (click)="sortTable('id')">
          <div class="d-flex align-items-center justify-content-center">
            ID
            <i class="material-icons text-black-50" *ngIf="localPageSettings.sort != 'id'">unfold_more</i>
            <i class="material-icons" *ngIf="localPageSettings.sort == 'id' && !localPageSettings.isSortDsc">expand_less</i>
            <i class="material-icons" *ngIf="localPageSettings.sort == 'id' && localPageSettings.isSortDsc">expand_more</i>
          </div>
        </th>
        <th scope="col" class="table-header-sortable" id="createdAtSort"
            (click)="sortTable('createdAt')">
          <div class="d-flex align-items-center justify-content-center">
            {{ 'Created at' | translate }}
            <i class="material-icons text-black-50" *ngIf="localPageSettings.sort != 'createdAt'">unfold_more</i>
            <i class="material-icons"
               *ngIf="localPageSettings.sort == 'createdAt' && !localPageSettings.isSortDsc">expand_less</i>
            <i class="material-icons"
               *ngIf="localPageSettings.sort == 'createdAt' && localPageSettings.isSortDsc">expand_more</i>
          </div>
        </th>
        <th scope="col" class="table-header-sortable" id="nameEFormSort"
            (click)="sortTable('label')">
          <div class="d-flex align-items-center justify-content-center">
            {{ 'eForm Name' | translate }}
            <i class="material-icons text-black-50" *ngIf="localPageSettings.sort != 'label'">unfold_more</i>
            <i class="material-icons" *ngIf="localPageSettings.sort == 'label' && !localPageSettings.isSortDsc">expand_less</i>
            <i class="material-icons" *ngIf="localPageSettings.sort == 'label' && localPageSettings.isSortDsc">expand_more</i>
          </div>
        </th>
        <th>{{ 'Tags' | translate }}</th>
        <th>{{ 'Pairing' | translate }}</th>
        <th>{{ 'Actions' | translate }}</th>
      </tr>
      </thead>
      <tbody id="mainPageEFormsTableBody">
      <tr *ngFor="let templateDto of templateListModel.templates">
        <td scope="row" id="eform-id">{{templateDto.id}}</td>
        <!--<td id="eform-created-at">{{templateDto.createdAt | date:'dd.MM.y HH:mm:ss'}}</td>-->
        <td id="eform-created-at"><date-formatter [date]="templateDto.createdAt" [Format]="'datetime'"></date-formatter></td>
        <td id="eform-label">{{templateDto.label}}</td>
        <td>
          <div class="d-flex justify-content-center">
            <div>
              <a class="btn btn-sm btn-success p-1 mb-2" *ngIf="checkEformPermissions(templateDto.id, userClaimsEnum.eFormsUpdateTags)"
                 id="eform-edit-btn"
                 mdbTooltip="{{ 'Edit tags' | translate }}" (click)="openEditTagsModal(templateDto)">
                {{ 'Edit tags' | translate }}
              </a>
              <ng-container *ngIf="checkEformPermissions(templateDto.id, userClaimsEnum.eFormsReadTags)">
                <p class="paragraph-sm" id="eform-tag" *ngFor="let tag of templateDto.tags">
                  {{tag.value}}
                </p>
              </ng-container>
            </div>
          </div>
        </td>
        <td>
          <div class="d-flex justify-content-center">
            <div>
              <button *ngIf="templateDto.deployedSites.length > 0
              && checkEformPermissions(templateDto.id, userClaimsEnum.eFormsPairingUpdate)"
                      id="eform-pairing-btn"
                      class="btn btn-success btn-sm p-1 mb-2" (click)="openPairingModal(templateDto)"
                      mdbTooltip="{{ 'Click to edit eForm pairing with user(s)' | translate }}">
                {{ 'Edit pairing' | translate }}
              </button>
              <button *ngIf="templateDto.deployedSites.length == 0 && checkEformPermissions(templateDto.id, userClaimsEnum.eFormsPairingUpdate)"
                      id="eform-add-btn"
                      class="btn btn-success btn-sm p-1 mb-2" (click)="openPairingModal(templateDto)"
                      mdbTooltip="{{ 'Click to pair eForm with user(s)' | translate }}">
                {{ 'Pair eForm' | translate }}
              </button>
              <ng-container *ngIf="checkEformPermissions(templateDto.id, userClaimsEnum.eFormsPairingRead)">
                <p class="paragraph-sm" id="eform-paired-username" *ngFor="let deployedSite of templateDto.deployedSites">
                  {{deployedSite.siteName}}
                </p>
              </ng-container>
            </div>
          </div>
        </td>
        <td>
          <div class="d-flex flex-row justify-content-center">
            <button class="btn btn-success btn-icon mb-2" *ngIf="templateDto.hasCases && checkEformPermissions(templateDto.id, userClaimsEnum.casesRead)"
                    id="eform-cases-btn"
                    [routerLink]="['/cases', templateDto.id]"
                    mdbTooltip="{{ 'Show cases' | translate }}">
              <i class="material-icons">
                work
              </i>
            </button>
            <button class="btn btn-success btn-icon mb-2" id="edit-columnts-btn"
                    *ngIf="checkEformPermissions(templateDto.id, userClaimsEnum.eFormsUpdateColumns)"
                    (click)="openEditColumnsModal(templateDto)"
                    mdbTooltip="{{ 'Edit columns' | translate }}">
              <fa-icon icon="table" [fixedWidth]="true" size="lg"></fa-icon>
            </button>
            <button class="btn btn-danger btn-icon mb-2" id="delete-eform-btn"
                    (click)="openEformDeleteModal(templateDto)"
                    *ngIf="checkEformPermissions(templateDto.id, userClaimsEnum.eFormsDelete)"
                    mdbTooltip="{{ 'Delete eForm' | translate }}">
              <fa-icon icon="trash-alt" [fixedWidth]="true" size="lg"></fa-icon>
            </button>
          </div>
          <div class="d-flex flex-row justify-content-center">
            <button class="btn btn-accent text-black-50 btn-icon mb-2"
                    *ngIf="templateDto.hasCases && checkEformPermissions(templateDto.id, userClaimsEnum.eFormsGetCsv)"
                    id="download-csv-btn"
                    (click)="downloadItem('CSV', templateDto.id)"
                    mdbTooltip="{{ 'Download' | translate }} CSV">
              <i class="material-icons">
                insert_drive_file
              </i>
            </button>
            <button class="btn btn-accent text-black-50 btn-icon mb-2"
                    *ngIf="templateDto.hasCases && checkEformPermissions(templateDto.id, userClaimsEnum.eFormsDownloadXml)"
                    id="download-xml-btn"
                    (click)="downloadItem('XML', templateDto.id)"
                    mdbTooltip="{{ 'Download' | translate }} XML">
              <i class="material-icons">
                code
              </i>
            </button>
            <button class="btn btn-accent text-black-50 btn-icon mb-2" id="upload-zip-btn"
                    (click)="uploadZipFile(templateDto)" *ngIf="checkEformPermissions(templateDto.id, userClaimsEnum.eFormsUploadZip)"
                    mdbTooltip="{{ 'Upload ZIP archive' | translate }}">
              <fa-icon icon="file-upload" [fixedWidth]="true" size="lg"></fa-icon>
            </button>
            <button class="btn btn-accent text-black-50 btn-icon mb-2" id="eform-report-button"
                    *ngIf="checkEformPermissions(templateDto.id, userClaimsEnum.eFormsReadJasperReport)"
                    [routerLink]="['./report', templateDto.id]"
                    mdbTooltip="{{ 'Jasper Report' | translate }}">
              <fa-icon icon="receipt" [fixedWidth]="true" size="lg"></fa-icon>
            </button>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>


  <!--pagination(if required)-->
</div>

<eform-spinner [spinnerVisibility]="spinnerStatus"></eform-spinner>

<app-eform-create-modal [availableTags]="availableTags" (onEformCreated)="loadAllTemplates()"
                        #modalNewEform></app-eform-create-modal>
<app-eform-column-modal #modalCasesColumns></app-eform-column-modal>
<app-eform-edit-paring-modal (onDeploymentFinished)="loadAllTemplates()" #modalParing></app-eform-edit-paring-modal>
<app-eform-edit-tags-modal [availableTags]="availableTags" (onEFormTagsUpdated)="loadAllTemplates()"
                           (onTagAdded)="loadAllTags()" #modalEditTags></app-eform-edit-tags-modal>
<app-eform-remove-eform-modal (onEFormDeleted)="loadAllTemplates()" #modalRemoveEform></app-eform-remove-eform-modal>
<app-eform-upload-zip-modal #modalUploadZip></app-eform-upload-zip-modal>
